external_url 'https://gitlab.example.com'  # HTTPS для клиентов
registry_external_url 'https://registry.gitlab.example.com'  # HTTPS для клиентов

# Внутри кластера - все по HTTP
nginx['listen_port'] = 80
nginx['listen_https'] = false
registry_nginx['listen_port'] = 4004
registry_nginx['listen_https'] = false

# Настройки Registry
gitlab_rails['registry_enabled'] = true
gitlab_rails['registry_host'] = "registry.gitlab.example.com"
gitlab_rails['registry_port'] = "443"
gitlab_rails['registry_api_url'] = "http://localhost:4004"
gitlab_rails['registry_issuer'] = "gitlab-issuer"

# Доверенные прокси
nginx['real_ip_trusted_addresses'] = ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']
registry_nginx['real_ip_trusted_addresses'] = ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']

# Заголовки для корректной работы за прокси
nginx['proxy_set_headers'] = {
  'X-Forwarded-Proto' => 'https',
  'X-Forwarded-Ssl' => 'on',
  'X-Forwarded-For' => '$proxy_add_x_forwarded_for',
  'Host' => '$http_host'
}

registry_nginx['proxy_set_headers'] = {
  'X-Forwarded-Proto' => 'https', 
  'X-Forwarded-Ssl' => 'on',
  'X-Forwarded-For' => '$proxy_add_x_forwarded_for',
  'Host' => '$http_host'
}
